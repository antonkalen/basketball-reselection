---
title: "Manuscript"
always_allow_html: true
output:
  bookdown::pdf_document2:
    toc: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(dplyr)
library(kableExtra)
library(tidyr)
library(glue)
library(tidybayes)
library(ggplot2)
library(gghighlight)
library(patchwork)

library(flextable)
library(modelr)
library(stringr)
library(knitr)

# Options
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
options(knitr.kable.NA = '')
theme_set(theme_bw())

# Smallest worthwhile change
swc_diff <- 0.03
swc_rr <- 0.05

# Variable names
var_names <- c(
  `genderMen` = "Men: Intercept",
  `genderWomen` = "Women: Intercept",
  `genderMen:c_log2_points` = "Men: Ranking Points",
  `genderWomen:c_log2_points` = "Women: Ranking Points",
  `genderMen:birth_quarter` = "Men: Birth Quarter",
  `genderWomen:birth_quarter` = "Women: Birth Quarter",
  `genderMen:c_log2_points:birth_quarter` = "Men: Birth Quarter × Ranking Points",
  `genderWomen:c_log2_points:birth_quarter` = "Women: Birth Quarter × Ranking Points",
  `Sigma[gender:category:(Intercept),(Intercept)]` = "Category",
  `Sigma[gender:category:c_log2_points,c_log2_points]` = "Category × Ranking Points",
  `Sigma[gender:category:birth_quarter,birth_quarter]` = "Category × Birth Quarter"
)

# Load drake components
drake::loadd(coef_table)
drake::loadd(loo_compare)
drake::loadd(data)
drake::loadd(draws_data)
drake::loadd(draws_gender)
drake::loadd(draws_points)
drake::loadd(draws_coefs)
drake::loadd(draws_birth_quarter)
drake::loadd(draws_coefs)
```
# Introduction

- Producing successful athletes are result of repeated selection process, not an initial selection and then long term intervention.
- The turnover/survival rate has been analyzed for example in soccer. But few studies looking at what influence the reelection.

# Method

## Sample

## Variables and procedure

## Statistical analysis
- RC -- Relative Chance (Relative risk)
- CI -- Compatibility interval
- LOO-IC -- Leave-one-out cross validation information criteria

# Results

The proportion of players reselected are presented in Table \@ref(tab:descriptive).
Model 3 showed the lowest relative LOO-IC of the four models compared.
All following results are therefore based on Model 3.
The model coefficients are presented in Table \@ref(tab:model3-table), for full table of model coefficients and LOO-IC, see Supplementary Material 1.

The model coefficients and the effects excluded suggest that the chance of reselection vary between debut and player ages; that there is a positive relationship between later birth quarter and higher chance of reselection, with equal effect across debut and player age; and that there is a positive relationship between higher ranking points and higher chance of reselection for women, and possibly for men, with different effect for different debut and player ages.

When taking into account the influence of the other variables, it is unclear if there is a difference in reselection chance between genders (intercept).
It is likely that the relationship between ranking points and reselection chance is stronger in women than men.
The relationship between birth quarter and reselection is similar for both genders.

```{r descriptive}
# Caclulate n for each group
n_debute <- data %>% 
  group_by(id) %>% 
  summarise(gender = unique(gender), debute = unique(debute)) %>% 
  count(gender, debute) %>% 
  mutate(debute = as.character(debute))

n_tot <- data %>% 
  group_by(id) %>% 
  summarise(gender = unique(gender)) %>% 
  count(gender) %>% 
  mutate(debute = "Mean")

n_col <- n_debute %>% 
  bind_rows(n_tot) %>% 
  arrange(gender, debute)

# Calculate season-to-season proportion

## Per debute and player age
reselection_debute_player_age <- data %>% 
  group_by(gender, debute, player_age) %>% 
  summarise(reselection = mean(selected) * 100) %>% 
  pivot_wider(names_from = player_age, values_from = reselection) %>% 
  ungroup() %>% 
  mutate(debute = as.character(debute))

## Total player age
reselection_player_age <- data %>% 
  group_by(gender, player_age) %>% 
  summarise(reselection = mean(selected) * 100) %>% 
  pivot_wider(names_from = player_age, values_from = reselection) %>% 
  mutate(debute = "Mean")

## Total debute
reselection_debute <- data %>% 
  group_by(gender, debute) %>% 
  summarise(reselection = mean(selected) * 100) %>% 
  rename(Total = reselection) %>% 
  mutate(debute = as.character(debute))

## Total gender
reselection_gender <- data %>% 
  group_by(gender) %>% 
  summarise(reselection = mean(selected) * 100) %>% 
  rename(Total = reselection) %>% 
  mutate(debute = "Mean")

## Join
reselection_tot_col <- reselection_debute %>% 
  bind_rows(reselection_gender)

reselection <- reselection_debute_player_age %>% 
  bind_rows(reselection_player_age) %>% 
  left_join(reselection_tot_col, by = c("gender", "debute")) %>% 
  arrange(gender, debute)


# Caclulate cumulative proportion
## Per debute and player age
cum_debute_player_age <- data %>% 
  group_by(gender, debute, player_age) %>% 
  summarise(reselection = mean(selected)) %>% 
  mutate(cum_prob = cumprod(reselection) * 100) %>% 
  select(-reselection) %>% 
  pivot_wider(names_from = player_age, values_from = cum_prob) %>% 
  ungroup() %>% 
  mutate(debute = as.character(debute))

## Total player age
cum_player_age <- cum_debute_player_age %>% 
  right_join(n_debute, by = c("gender", "debute")) %>% 
  group_by(gender) %>% 
  summarise_at(vars(`16`:`20`), ~weighted.mean(., n, na.rm = TRUE)) %>% 
  mutate(debute = "Mean")

cum <- cum_debute_player_age %>% 
  bind_rows(cum_player_age) %>% 
  arrange(gender, debute)

# Create table
n_col %>% 
  left_join(reselection, by = c("gender", "debute")) %>% 
  left_join(cum, by = c("gender", "debute")) %>% 
  select(-gender) %>% 
  kable(
    col.names = c("Debut", "n", 16:20, "Mean", 16:20),
    caption = "Season-to-season and cumulative reselection proportion by debut and age",
    digits = 1,
    booktabs = TRUE
  ) %>% 
  kable_styling(latex_options = c("HOLD_position")) %>% 
  add_header_above(
      c(
      "",
      "",
      "Reselection percentage" = 6, 
      "Cumulative percentage" = 5
      )
  ) %>% 
  pack_rows(index = c("Men" = 6, "Women" = 6))
```

```{r model3-table}

# Rename and reorder variables
coef_table <- coef_table %>%
  mutate(.variable = recode(.variable, !!!var_names)) %>% 
  arrange(factor(.variable, levels = var_names))

# Comparisons
gender_diff_table <- draws_coefs %>% 
  group_by(.variable) %>% 
  compare_levels(
    variable = .value,
    by = gender
  ) %>% 
  mean_hdi() %>% 
  ungroup() %>% 
  select(.variable, .value, .lower, .upper) %>% 
  add_row(
    .variable = c(
      "intercept", 
      "c_log2_points", 
      "birth_quarter", 
      NA, 
      NA
    )
  ) %>% 
  arrange(
    factor(
      .variable, 
      levels = c("intercept", "c_log2_points", "birth_quarter")
    ),
    !is.na(.value)
  ) %>% select(-.variable)

coef_table %>% 
  select(.variable, starts_with("model_3")) %>% 
  drop_na() %>% 
  bind_cols(gender_diff_table) %>% 
  kable(
    .,
    col.names = c("", "Coef", "LL", "UL", "Diff", "LL", "UL"),
    digits = 2,
    caption = "Coefficient of Model 3 and difference between genders",
    booktabs = TRUE
  ) %>% 
    kable_styling(latex_options = c("HOLD_position")) %>% 
    add_header_above(c("", "", "95% CI" = 2, "", "95% CI" = 2)) %>% 
    add_header_above(c("", "", "", "", "Women - Men" = 3)) %>% 
    pack_rows(index = c("Fixed Effects" = 6, "Random Effects" = 2))
```

## Debut age

The relative chance of remaining selected until age 20 between different debut ages are presented in Table \@ref(tab:debut-rr). For men, the chance of remaining selected until the age of 20 is lower for players debuting at age 16 compared to all other ages. In general, there tend to be a higher chance for players debuting at 15, 17 and 19 compared to 16 and 18. For women, the chance for players debuting at 15 is higher compared to all other ages. The chance for debut ages 17, 18 and 19 seem to be similar to each other. The chance of remaining selected over the years for each debut age can be seen in Figure \@ref(fig:debut-fig).

```{r debut-rr}
cum_prob_rr <- draws_gender %>% 
  filter(player_age == 20) %>% 
  compare_levels(
    cum_prob,
    by = debute,
    fun = `/`,
    draw_indices = c("gender", ".draw")
  ) %>% 
  group_by(gender, debute) %>% 
  mean_hdi(cum_prob) %>% 
  select(-.width:-.interval)

cum_prob_rr %>% 
  ungroup(gender) %>% 
  select(-gender) %>% 
  kable(
    col.names = c("Debut", "RC", "LL", "UL"),
    caption = "Relative chance of remaining selected until age 20 between different debut ages",
    digits = 2,
    booktabs = TRUE
  ) %>% 
  kable_styling() %>% 
  add_header_above(c("", "", "95% CI" = 2)
  ) %>% 
  pack_rows(index = c("Men" = 10, "Women" = 10))

```

```{r debut-fig, fig.asp=.5, fig.cap="Chance of remaining selected by debute age, with 95% compatibility interval. Gray line indicate chance of remaining for all players."}
first_year <- draws_gender %>% 
  expand(nesting(gender, debute)) %>% 
  mutate(
    player_age = debute,
    cum_prob = 1,
    .lower_0.66 = 1,
    .lower_0.95 = 1,
    .upper_0.66 = 1,
    .upper_0.95 = 1
  )

debute_plot_data <- draws_gender %>% 
  group_by(gender, debute, player_age) %>% 
  mean_hdi(cum_prob, .width = c(.66, .95)) %>% 
  pivot_wider(names_from = .width, values_from = c(.lower, .upper)) %>% 
  bind_rows(first_year)

avg_cum <- cum_player_age %>% 
  select(-debute) %>% 
  pivot_longer(
    `16`:`20`, 
    names_to = "player_age",
    names_ptypes = list(player_age = integer()),
    values_to = "avg_cum_prob"
  ) %>% 
  mutate(avg_cum_prob = avg_cum_prob / 100) %>% 
  expand(nesting(gender, player_age, avg_cum_prob), debute = 15:19)

debute_plot_data2 <- debute_plot_data %>% 
  full_join(avg_cum, by = c("gender", "debute", "player_age"))

# Labels
debute_labels <- function(string) {paste("Debut", string)}

debute_plot_data2 %>% 
  ggplot(aes(x = player_age, y = cum_prob)) +
  geom_line(aes(y = avg_cum_prob, group = 1), color = "gray70") +
  geom_ribbon(aes(ymin = .lower_0.95, ymax = .upper_0.95), alpha = .3) +
  geom_line() +
  facet_grid(
    cols = vars(debute),
    rows = vars(gender),
    labeller = labeller(debute = debute_labels),
    switch = "y"
  ) +
  theme(
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside"
  ) +
  ylab(NULL) +
  xlab(NULL)

```


## Ranking points
The estimated marginal chance of remaining selected until 20 in top and bottom ranked countries, together with the relative chance are presented in Table \@ref(tab:ranking-points-rr). For men, players in top ranked countries have a higher chance of remaining selected until 20 than players from bottom ranked teams when debuting at age 16 or 19. For women, the higher players in top ranked countries have a higher chance of remaining selected until 20 than players from bottom ranked teams for all debut ages. The chance of remaining selected over the years in top and bottom ranked countries can be seen in Figure \@ref(fig:ranking-fig).

```{r ranking-points-rr}

draws_points_cum <- draws_points %>% 
  group_by(gender) %>% 
  filter(
    player_age == 20,
    c_log2_points %in% c(min(c_log2_points), max(c_log2_points))
  ) %>% 
  mutate(
    ranking_points = case_when(
      c_log2_points == min(c_log2_points) ~ "Bottom",
      c_log2_points == max(c_log2_points) ~ "Top",
    )
  )

points_emm <- draws_points_cum %>% 
  group_by(gender, debute, ranking_points) %>% 
  mean_hdci(cum_prob) %>% 
  select(-.width:-.interval) %>% 
  pivot_wider(names_from = ranking_points, values_from = c(cum_prob, .lower, .upper)) %>% 
  select(gender, contains("Top"), contains("Bottom"))

points_comp <- draws_points_cum %>% 
  compare_levels(
    cum_prob,
    by = ranking_points,
    fun = `/`,
    draw_indices = c("gender", "debute", ".draw")
  ) %>% 
  group_by(gender, debute)

points_rr <- points_comp %>% 
  mean_hdci(cum_prob) %>% 
  select(-.width:-.interval)

points_emm %>% 
  left_join(points_rr, by = c("gender", "debute")) %>% 
  ungroup() %>% 
  select(-gender) %>% 
  kable(
    col.names = c("Debut", rep(c("Est", "LL", "UL"), 2), "RC", "LL", "UL"),
    caption = "Relative chance of remaining selected until age 20 between top and bottom ranked countries",
    digits = 2,
    booktabs = TRUE
  ) %>% 
  kable_styling() %>% 
  add_header_above(
    c(
      "",
      "",
      "95% CI" = 2,
      "",
      "95% CI" = 2,
      "",
      "95% CI" = 2
    )
  ) %>% 
  add_header_above(c("", "Top" = 3, "Bottom" = 3, "Top / Bottom" = 3)) %>% 
  pack_rows(
    index = c(
      "Men" = 5, 
      "Women" = 5
    )
  )

```

```{r ranking-fig, fig.asp=.5, fig.cap="Chance of remaining selected in top and bottom ranked countries by debute age, with 95% compatibility interval."}

first_year_ranking <- draws_points_cum %>% 
  expand(nesting(gender, debute, ranking_points)) %>% 
  mutate(
    player_age = debute,
    cum_prob = 1,
    .lower_0.66 = 1,
    .lower_0.95 = 1,
    .upper_0.66 = 1,
    .upper_0.95 = 1
  ) %>% 
  mutate(ranking_points = factor(ranking_points, levels = c("Top", "Bottom")))

ranking_plot_data <- draws_points %>% 
  group_by(gender) %>% 
  filter(c_log2_points %in% c(min(c_log2_points), max(c_log2_points))) %>% 
  mutate(
    ranking_points = case_when(
      c_log2_points == min(c_log2_points) ~ "Bottom",
      c_log2_points == max(c_log2_points) ~ "Top",
    ),
    ranking_points = factor(ranking_points, levels = c("Top", "Bottom"))
  ) %>% 
  group_by(gender, ranking_points, debute, player_age) %>% 
  mean_hdi(cum_prob, .width = c(.66, .95)) %>% 
  pivot_wider(names_from = .width, values_from = c(.lower, .upper)) %>% 
  bind_rows(first_year_ranking)

ranking_plot_data %>% 
  ggplot(aes(x = player_age, y = cum_prob, group = ranking_points)) +
  geom_ribbon(aes(ymin = .lower_0.95, ymax = .upper_0.95), alpha = .3) +
  geom_line(aes(linetype = ranking_points)) +
  facet_grid(
    cols = vars(debute),
    rows = vars(gender),
    labeller = labeller(debute = debute_labels),
    switch = "y"
  ) +
  scale_linetype_discrete(labels = c("Top ranked", "Bottom ranked")) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.margin = margin(0,0,0,0),
    strip.text = element_text(margin = margin(0,0,0,0)),
    strip.background = element_blank(),
    strip.placement = "outside",
    plot.margin = margin(0, 0, 0, 0, "cm")
  ) +
  ylab(NULL) +
  xlab(NULL)

```

## Birth quarter

```{r}
birth_quarter_cum <- draws_birth_quarter %>% 
  group_by(gender) %>% 
  filter(
    player_age == 20,
    birth_quarter %in% c(min(birth_quarter), max(birth_quarter))
  ) %>% 
  mutate(
    birth_quarter = case_when(
      birth_quarter == min(birth_quarter) ~ "Q1",
      birth_quarter == max(birth_quarter) ~ "Q4",
    )
  )

birth_quarter_emm <- birth_quarter_cum %>% 
  group_by(gender, birth_quarter) %>% 
  mean_hdci(cum_prob) %>% 
  select(-.width:-.interval) %>% 
  pivot_wider(names_from = birth_quarter, values_from = c(cum_prob, .lower, .upper)) %>% 
  select(gender, contains("Q1"), contains("Q4")) %>% 
  mutate_if(is.numeric, ~formatC(round(., digits = 2), digits = 2, format = "f"))

birth_quarter_comp <- birth_quarter_cum %>% 
  compare_levels(
    cum_prob,
    by = birth_quarter,
    fun = `/`,
    draw_indices = c("gender", "debute", ".draw")
  ) %>% 
  group_by(gender)

birth_quarter_rr <- birth_quarter_comp %>% 
  mean_hdci(cum_prob) %>% 
  select(-.width:-.interval) %>% 
  mutate_if(is.numeric, ~formatC(round(., digits = 2), digits = 2, format = "f"))

```


For men, the estimated marginal chance of remaining selected until 20 for players born in quarter 1 is `r birth_quarter_emm %>% filter(gender == "Men") %>% glue_data("{cum_prob_Q1} 95% CI [{.lower_Q1}, {.upper_Q1}]")`, and for players born in quarter 4 `r birth_quarter_emm %>% filter(gender == "Men") %>% glue_data("{cum_prob_Q4} 95% CI [{.lower_Q4}, {.upper_Q4}]")`. Players born in quarter 4 have `r birth_quarter_rr %>% filter(gender == "Men") %>% glue_data("{cum_prob} times 95% CI [{.lower}, {.upper}]")` higher chance of remaining selected compared to players born in quarter 1.
For women, the estimated marginal chance of remaining selected until 20 for players born in quarter 1 is `r birth_quarter_emm %>% filter(gender == "Women") %>% glue_data("{cum_prob_Q1} 95% CI [{.lower_Q1}, {.upper_Q1}]")`, and for players born in quarter 4 `r birth_quarter_emm %>% filter(gender == "Women") %>% glue_data("{cum_prob_Q4} 95% CI [{.lower_Q4}, {.upper_Q4}]")`. Players born in quarter 4 have `r birth_quarter_rr %>% filter(gender == "Women") %>% glue_data("{cum_prob} times 95% CI [{.lower}, {.upper}]")` higher chance of remaining selected compared to players born in quarter 1. The chance of remaining selected over the years in top and bottom ranked countries can be seen in Figure \@ref(fig:quarter-fig).

```{r quarter-fig, fig.asp=.5, fig.cap="Chance of remaining selected for players born in quarter 1 and 4, with 95% compatibility interval."}

first_year_quarter <- birth_quarter_cum %>% 
  expand(nesting(gender, debute, birth_quarter)) %>% 
  mutate(
    player_age = debute,
    cum_prob = 1,
    .lower_0.66 = 1,
    .lower_0.95 = 1,
    .upper_0.66 = 1,
    .upper_0.95 = 1
  )

quarter_plot_data <- draws_birth_quarter %>% 
  group_by(gender) %>% 
  filter(birth_quarter %in% c(min(birth_quarter), max(birth_quarter))) %>% 
  mutate(
    birth_quarter = case_when(
      birth_quarter == min(birth_quarter) ~ "Q1",
      birth_quarter == max(birth_quarter) ~ "Q4",
    )
  ) %>% 
  group_by(gender, birth_quarter, debute, player_age) %>% 
  mean_hdi(cum_prob, .width = c(.66, .95)) %>% 
  pivot_wider(names_from = .width, values_from = c(.lower, .upper)) %>% 
  bind_rows(first_year_quarter)

quarter_plot_data %>% 
  ggplot(aes(x = player_age, y = cum_prob, group = birth_quarter)) +
  geom_ribbon(aes(ymin = .lower_0.95, ymax = .upper_0.95), alpha = .3) +
  geom_line(aes(linetype = birth_quarter)) +
  facet_grid(
    cols = vars(debute),
    rows = vars(gender),
    labeller = labeller(debute = debute_labels),
    switch = "y"
  ) +
  scale_linetype_discrete(labels = c("Quarter 1", "Quarter 4")) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.margin = margin(0,0,0,0),
    strip.text = element_text(margin = margin(0,0,0,0)),
    strip.background = element_blank(),
    strip.placement = "outside",
    plot.margin = margin(0, 0, 0, 0, "cm")
  ) +
  ylab(NULL) +
  xlab(NULL)

```

# Discussion

## Debut age

Two patterns:

- Later debut = higher probability remain until 20. (Later initial selection = more sure about talent? Or, later initial selection = fewer seasons to get kicked out?)
- Debut as underaged (15, 17, 19) = higher probability to remain selected until 20. (Initial selection when younger requires more talent? Players making debut as oldest in agegroup (16, 18) are "utfyllnadsspelare"?)

## Player age

- Highest reselection from underage to oldest in agegroup (15 to 16, 17 to 18). 90% of players that participated first year in a agegroup were reselected the year after. (In line with results about debut age).
- Less differences in women.

# Supplementary material 1 {-}

```{r model-comparison}
# Prep looic values
loos <- loo_compare %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column() %>% 
  select(.value = rowname, value = elpd_diff, lower = se_diff) %>% 
  pivot_longer(cols = c(value, lower), names_to = "names") %>% 
  mutate(
    value = if_else(names == "value", value * -2, value * 2),
    names = paste(.value, names, sep = "."),
    .variable = "Relative LOO-IC (SE)"
  ) %>% 
  select(-.value) %>% 
  pivot_wider(names_from = names, values_from = value)

# Rename and reorder variables
coef_table <- coef_table %>%
  mutate(.variable = recode(.variable, !!!var_names)) %>% 
  arrange(factor(.variable, levels = var_names))

# Column names
col_names <- c("", rep(c("Est", "LL", "UL"), times = 4))

coef_table %>% 
  bind_rows(loos) %>% 
  kable(
    .,
    col.names = col_names,
    digits = 2,
    caption = "Coefficients and cross-validation for all models",
    booktabs = TRUE
  ) %>% 
    kable_styling(latex_options = c("scale_down", "HOLD_position")) %>% 
    add_header_above(c(
      "",
      "", "95% CI" = 2,
      "", "95% CI" = 2,
      "", "95% CI" = 2,
      "", "95% CI" = 2
    )) %>% 
    add_header_above(c(
      "", 
      "Model 1" = 3, 
      "Model 2" = 3, 
      "Model 3" = 3, 
      "Model 4" = 3
    )) %>% 
    pack_rows(index = c("Fixed Effects" = 8, "Random Effects" = 3, "Cross-Validation"))
```
